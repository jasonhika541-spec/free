name: Simple Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Clean problematic directories
      run: |
        if [ -d "READM1E.md" ]; then
          rm -rf READM1E.md
          echo "Removed problematic READM1E.md directory"
        fi
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'
    
    - name: Install Theos (Simple)
      run: |
        # Install Theos
        export THEOS=/opt/theos
        echo "Installing Theos to $THEOS"
        
        sudo rm -rf $THEOS || true
        sudo git clone --recursive https://github.com/theos/theos.git $THEOS
        sudo chown -R $(id -u):$(id -g) $THEOS
        
        # Use Xcode's built-in iOS SDK
        XCODE_PATH=$(xcode-select -p)
        IOS_SDK_PATH="$XCODE_PATH/Platforms/iPhoneOS.platform/Developer/SDKs"
        
        echo "Looking for iOS SDKs in: $IOS_SDK_PATH"
        ls -la "$IOS_SDK_PATH"
        
        # Find and link the latest iOS SDK
        LATEST_SDK=$(ls "$IOS_SDK_PATH" | grep "iPhoneOS.*\.sdk" | sort -V | tail -1)
        if [ -n "$LATEST_SDK" ]; then
          echo "Using iOS SDK: $LATEST_SDK"
          ln -sf "$IOS_SDK_PATH/$LATEST_SDK" "$THEOS/sdks/$LATEST_SDK"
          
          # Also create a generic link
          ln -sf "$IOS_SDK_PATH/$LATEST_SDK" "$THEOS/sdks/iPhoneOS.sdk"
        else
          echo "❌ No iOS SDK found in Xcode"
          exit 1
        fi
        
        # Verify SDK installation
        echo "Installed SDKs:"
        ls -la $THEOS/sdks/
        
        echo "THEOS=/opt/theos" >> $GITHUB_ENV
        echo "PATH=/opt/theos/bin:$PATH" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        brew install ldid
        
        # Verify installation
        echo "Theos directory:"
        ls -la $THEOS
        echo "Available SDKs:"
        ls -la $THEOS/sdks/
    
    - name: Build project
      run: |
        export THEOS=/opt/theos
        export PATH=/opt/theos/bin:$PATH
        
        echo "Building with Theos..."
        echo "THEOS: $THEOS"
        
        # Clean and build
        make clean || true
        make package FINALPACKAGE=1 FOR_RELEASE=1
        
        # Check build result
        if [ -d ".theos/_/Applications/crepware.app" ]; then
          echo "✅ Build successful!"
          ls -la .theos/_/Applications/crepware.app/
        else
          echo "❌ Build failed - app not found"
          echo "Contents of .theos/_/Applications/:"
          ls -la .theos/_/Applications/ || echo "Directory not found"
          exit 1
        fi
    
    - name: Create .tipa file
      run: |
        mkdir -p packages
        rm -rf packages/*
        
        # Create Payload directory
        mkdir -p Payload
        cp -r .theos/_/Applications/crepware.app Payload/
        
        # Create .tipa file
        cd Payload
        zip -r ../packages/crepware.tipa . -q
        cd ..
        
        # Clean up
        rm -rf Payload
        
        # Verify
        if [ -f "packages/crepware.tipa" ]; then
          echo "✅ .tipa created successfully"
          ls -lh packages/crepware.tipa
        else
          echo "❌ Failed to create .tipa"
          exit 1
        fi
    
    - name: Upload .tipa artifact
      uses: actions/upload-artifact@v4
      with:
        name: crepware-tipa-simple
        path: packages/crepware.tipa
        retention-days: 30