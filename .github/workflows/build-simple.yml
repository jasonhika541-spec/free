name: Simple Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Clean problematic directories
      run: |
        if [ -d "READM1E.md" ]; then
          rm -rf READM1E.md
          echo "Removed problematic READM1E.md directory"
        fi
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'
    
    - name: Install Theos (Simple)
      run: |
        # Install Theos
        export THEOS=/opt/theos
        echo "Installing Theos to $THEOS"
        
        sudo rm -rf $THEOS || true
        sudo git clone --recursive https://github.com/theos/theos.git $THEOS
        sudo chown -R $(id -u):$(id -g) $THEOS
        
        # Use Xcode's built-in iOS SDK
        XCODE_PATH=$(xcode-select -p)
        IOS_SDK_PATH="$XCODE_PATH/Platforms/iPhoneOS.platform/Developer/SDKs"
        
        echo "Looking for iOS SDKs in: $IOS_SDK_PATH"
        ls -la "$IOS_SDK_PATH"
        
        # Use Xcode's built-in iOS SDK
        XCODE_PATH=$(xcode-select -p)
        IOS_SDK_PATH="$XCODE_PATH/Platforms/iPhoneOS.platform/Developer/SDKs"
        
        echo "Looking for iOS SDKs in: $IOS_SDK_PATH"
        ls -la "$IOS_SDK_PATH"
        
        # Find and link the latest iOS SDK
        LATEST_SDK=$(ls "$IOS_SDK_PATH" | grep "iPhoneOS.*\.sdk" | sort -V | tail -1)
        if [ -n "$LATEST_SDK" ]; then
          echo "Using iOS SDK: $LATEST_SDK"
          ln -sf "$IOS_SDK_PATH/$LATEST_SDK" "$THEOS/sdks/$LATEST_SDK"
          
          # Create multiple compatibility links
          ln -sf "$IOS_SDK_PATH/$LATEST_SDK" "$THEOS/sdks/iPhoneOS.sdk"
          ln -sf "$IOS_SDK_PATH/$LATEST_SDK" "$THEOS/sdks/iPhoneOS16.5.sdk"
          ln -sf "$IOS_SDK_PATH/$LATEST_SDK" "$THEOS/sdks/iPhoneOS17.0.sdk"
          
          # Extract version number and create version-specific link
          SDK_VERSION=$(echo "$LATEST_SDK" | sed 's/iPhoneOS\([0-9]*\.[0-9]*\)\.sdk/\1/')
          if [ -n "$SDK_VERSION" ]; then
            echo "SDK Version: $SDK_VERSION"
            ln -sf "$IOS_SDK_PATH/$LATEST_SDK" "$THEOS/sdks/iPhoneOS${SDK_VERSION}.sdk"
          fi
        else
          echo "❌ No iOS SDK found in Xcode"
          exit 1
        fi
        
        # Copy project headers to Theos include directory
        echo "Copying project headers to Theos..."
        mkdir -p $THEOS/vendor/include/
        cp -r headers/* $THEOS/vendor/include/ 2>/dev/null || true
        
        # Also copy to a custom include directory
        mkdir -p $THEOS/include/
        cp -r headers/* $THEOS/include/ 2>/dev/null || true
        
        # Verify headers were copied
        echo "Verifying header copy:"
        echo "Headers in project:"
        ls -la headers/
        echo "Headers in Theos vendor/include:"
        ls -la $THEOS/vendor/include/ | head -10
        echo "Headers in Theos include:"
        ls -la $THEOS/include/ | head -10
        
        # Test if BackboardServices.h is accessible
        echo "Testing BackboardServices.h access:"
        test -f "headers/BackboardServices.h" && echo "✅ Found in headers/" || echo "❌ Not found in headers/"
        test -f "$THEOS/vendor/include/BackboardServices.h" && echo "✅ Found in Theos vendor/include/" || echo "❌ Not found in Theos vendor/include/"
        test -f "$THEOS/include/BackboardServices.h" && echo "✅ Found in Theos include/" || echo "❌ Not found in Theos include/"
        
        # Verify SDK installation
        echo "Installed SDKs:"
        ls -la $THEOS/sdks/
        
        echo "THEOS=/opt/theos" >> $GITHUB_ENV
        echo "PATH=/opt/theos/bin:$PATH" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        brew install ldid
        
        # Verify installation
        echo "Theos directory:"
        ls -la $THEOS
        echo "Available SDKs:"
        ls -la $THEOS/sdks/
    
    - name: Build project
      run: |
        export THEOS=/opt/theos
        export PATH=/opt/theos/bin:$PATH
        
        echo "Building with Theos..."
        echo "THEOS: $THEOS"
        
        # Show available SDKs
        echo "Available SDKs in Theos:"
        ls -la $THEOS/sdks/
        
        # Test SDK detection logic
        echo "Testing SDK detection:"
        ls $THEOS/sdks/ | grep "iPhoneOS.*\.sdk" || echo "No versioned SDKs found"
        ls $THEOS/sdks/ | grep "iPhoneOS[0-9].*\.sdk" || echo "No numbered SDKs found"
        
        # Show what makefile would detect
        echo "Makefile SDK detection test:"
        AVAILABLE_SDKS=$(ls $THEOS/sdks/ 2>/dev/null | grep "iPhoneOS[0-9].*\.sdk" | head -1)
        echo "AVAILABLE_SDKS: '$AVAILABLE_SDKS'"
        if [ -n "$AVAILABLE_SDKS" ]; then
          SDK_VERSION=$(echo "$AVAILABLE_SDKS" | sed 's/iPhoneOS\([0-9]*\.[0-9]*\)\.sdk/\1/')
          echo "SDK_VERSION: '$SDK_VERSION'"
        fi
        
        # Check headers directory
        echo "Headers directory contents:"
        ls -la headers/
        
        # Check current directory structure
        echo "Current directory:"
        pwd
        ls -la
        
        # Test if headers are accessible
        echo "Testing header file access:"
        test -f "headers/BackboardServices.h" && echo "✅ BackboardServices.h found" || echo "❌ BackboardServices.h not found"
        
        # Show compiler include paths
        echo "Testing compiler include paths:"
        echo '#include "BackboardServices.h"' | clang -v -E -x objective-c - -I headers -I $THEOS/vendor/include -I $THEOS/include 2>&1 | grep -E "(include|error)" | head -10 || true
        
        # Show what clang can find
        echo "Testing clang header search:"
        clang -v -E -x objective-c /dev/null -I headers 2>&1 | grep "search starts here" -A 10 || true
        
        # Use simple makefile with absolute paths
        echo "Using simplified makefile..."
        cp makefile.simple makefile.backup
        
        # Clean and build
        make clean || true
        
        # Set explicit TARGET to avoid SDK detection issues
        export TARGET="iphone:clang"
        echo "Using TARGET: $TARGET"
        
        # Create additional header symlinks in current directory
        echo "Creating header symlinks..."
        ln -sf headers/BackboardServices.h BackboardServices.h 2>/dev/null || true
        ln -sf headers/AXEventRepresentation.h AXEventRepresentation.h 2>/dev/null || true
        ln -sf headers/UIApplication+Private.h UIApplication+Private.h 2>/dev/null || true
        
        # Also try copying headers to sources directory
        cp headers/*.h sources/ 2>/dev/null || true
        
        echo "Header files in current directory:"
        ls -la *.h 2>/dev/null || echo "No .h files in current directory"
        echo "Header files in sources directory:"
        ls -la sources/*.h 2>/dev/null | head -5 || echo "No .h files in sources directory"
        
        # Try building with different makefile variants (from simplest to complex)
        if make -f makefile.aggressive package FINALPACKAGE=1 FOR_RELEASE=1 V=1; then
          echo "✅ Build successful with aggressive makefile!"
        elif make -f makefile.noversion package FINALPACKAGE=1 FOR_RELEASE=1 V=1; then
          echo "✅ Build successful with no-version makefile!"
        elif make -f makefile.simple package FINALPACKAGE=1 FOR_RELEASE=1 V=1; then
          echo "✅ Build successful with simple makefile!"
        elif make -f makefile.absolute package FINALPACKAGE=1 FOR_RELEASE=1 V=1; then
          echo "✅ Build successful with absolute makefile!"
        else
          echo "All makefiles failed, trying with manual flags..."
          
          # Try with very aggressive manual compiler flags
          CURRENT_DIR=$(pwd)
          make package FINALPACKAGE=1 FOR_RELEASE=1 TARGET=iphone:clang \
            crepware_CFLAGS="-I. -I${CURRENT_DIR}/headers -I${CURRENT_DIR}/sources -I${CURRENT_DIR}/sources/KIF -I${THEOS}/vendor/include -I${THEOS}/include -fobjc-arc -Wno-deprecated-declarations" \
            V=1 || exit 1
        fi
        
        # Check build result
        if [ -d ".theos/_/Applications/crepware.app" ]; then
          echo "✅ Build successful!"
          ls -la .theos/_/Applications/crepware.app/
        else
          echo "❌ Build failed - app not found"
          echo "Contents of .theos/_/Applications/:"
          ls -la .theos/_/Applications/ || echo "Directory not found"
          exit 1
        fi
    
    - name: Create .tipa file
      run: |
        mkdir -p packages
        rm -rf packages/*
        
        # Create Payload directory
        mkdir -p Payload
        cp -r .theos/_/Applications/crepware.app Payload/
        
        # Create .tipa file
        cd Payload
        zip -r ../packages/crepware.tipa . -q
        cd ..
        
        # Clean up
        rm -rf Payload
        
        # Verify
        if [ -f "packages/crepware.tipa" ]; then
          echo "✅ .tipa created successfully"
          ls -lh packages/crepware.tipa
        else
          echo "❌ Failed to create .tipa"
          exit 1
        fi
    
    - name: Upload .tipa artifact
      uses: actions/upload-artifact@v4
      with:
        name: crepware-tipa-simple
        path: packages/crepware.tipa
        retention-days: 30